# é¢„è®­ç»ƒæ‰©æ•£æ¨¡å‹é…ç½®
# ä½¿ç”¨HuggingFaceé¢„è®­ç»ƒDDPM + å˜åˆ†æ¨æ–­æ¶æ„

batch_size: 8            # Clusterç¯å¢ƒï¼Œå¯ä»¥å¢å¤§batch sizeåŠ å¿«è®­ç»ƒ
n_workers: 16
iterations: 30000        # é¢„è®­ç»ƒæ¨¡å‹æ”¶æ•›æ›´å¿«ï¼Œ30000æ­¥é€šå¸¸è¶³å¤Ÿ
eval_every: 1
accumulate_grad_batches: 1
fp16: False             # è®¾ç½®ä¸ºFalseé¿å…æ¨ç†æ—¶çš„æ•°æ®ç±»å‹ä¸åŒ¹é…é—®é¢˜
clip_denoised: True
ema_rate: 0.999

# Early Stopping é…ç½®
early_stopping:
  enabled: True
  patience: 3
  min_delta: 0.001
  monitor: val/total_loss

# å­¦ä¹ ç‡ï¼ˆé¢„è®­ç»ƒæ¨¡å‹ä½¿ç”¨æ›´å°çš„lrï¼‰
lr: 5e-5                  # æ¯”ä»å¤´è®­ç»ƒå°2å€
wd: "1e-4"


fine_tune_from: null
schedule_sampler: uniform  # æ³¨æ„ï¼šæ­¤é…ç½®ä»…ç”¨äºå…¼å®¹æ€§ï¼Œå®é™…ä½¿ç”¨DDPMScheduler

# ğŸŒŸ é¢„è®­ç»ƒæ¨¡å‹é…ç½®
pretrained:
  # HuggingFaceæ¨¡å‹ID
  # æ¨èé€‰é¡¹ï¼š
  #   - google/ddpm-celebahq-256: 256x256 äººè„¸æ•°æ®é›†
  #   - google/ddpm-ema-church-256: 256x256 æ•™å ‚æ•°æ®é›†
  #   - google/ddpm-bedroom-256: 256x256 å§å®¤æ•°æ®é›†
  model_id: "google/ddpm-celebahq-256"

  # ğŸŒŸ è½»é‡åŒ–é…ç½®ï¼ˆå¯é€‰ï¼‰
  # å¦‚æœæœªæŒ‡å®šæˆ–è®¾ç½®ä¸ºnullï¼Œå°†ä½¿ç”¨åŸå§‹é¢„è®­ç»ƒæ¨¡å‹çš„å®Œæ•´å¤§å°
  # é¢„è®¾é€‰é¡¹ï¼š
  #   - "small": å‚æ•°é‡å‡å°‘çº¦75%ï¼ˆblock_out_channelså‡åŠï¼Œlayers_per_block=1ï¼‰
  #   - "medium": å‚æ•°é‡å‡å°‘çº¦50%ï¼ˆblock_out_channelså‡åŠï¼Œlayers_per_blockä¿æŒåŸå€¼ï¼‰
  #   - "large": ä½¿ç”¨åŸå§‹é¢„è®­ç»ƒæ¨¡å‹ï¼ˆç­‰åŒäºnullï¼‰
  #   - null: ä½¿ç”¨åŸå§‹é¢„è®­ç»ƒæ¨¡å‹ï¼ˆé»˜è®¤ï¼‰
  model_size: "small"  # å¯é€‰: "small", "medium", "large", null

  # å†»ç»“ç­–ç•¥
  # - "all": å®Œå…¨å†»ç»“æ‰©æ•£æ¨¡å‹ï¼Œåªè®­ç»ƒå˜åˆ†æ¨æ–­æ¨¡å—
  # - "partial": éƒ¨åˆ†å†»ç»“ï¼Œåªè®­ç»ƒæŒ‡å®šæ¨¡å—
  # - "none": ä¸å†»ç»“ï¼Œå…¨éƒ¨å¾®è°ƒ
  freeze_strategy: "all"

  # å½“freeze_strategyä¸º"partial"æ—¶ï¼ŒæŒ‡å®šå¯è®­ç»ƒçš„æ¨¡å—
  # æ¨èé…ç½®ï¼šåªè®­ç»ƒè¾“å…¥å±‚å’Œç¬¬ä¸€ä¸ªä¸‹é‡‡æ ·å—
  trainable_modules:
    - "conv_in"           # è¾“å…¥å·ç§¯å±‚ï¼ˆå¿…é¡»è®­ç»ƒï¼Œå› ä¸ºé€šé“æ•°æ”¹å˜äº†ï¼‰
    - "down_blocks.0"     # ç¬¬ä¸€ä¸ªä¸‹é‡‡æ ·å—ï¼ˆå­¦ä¹ ç‰¹å®šé¢†åŸŸç‰¹å¾ï¼‰

# æ¨¡å‹é…ç½®ï¼ˆç”¨äºscheduleråˆå§‹åŒ–ï¼‰
model:
  use_y_conditioning: False
  diffusion_steps: 200    # ä¸é¢„è®­ç»ƒæ¨¡å‹ä¸€è‡´
  attention_resolutions: "32,16,8"  # æ­¤é…ç½®ä»…ç”¨äºè®°å½•ï¼Œå®é™…ç”±é¢„è®­ç»ƒæ¨¡å‹å†³å®š

# ğŸŒŸ å˜åˆ†æ¨æ–­é…ç½®ï¼ˆä¿æŒä¸å˜ï¼‰
latent:
  enabled: True

  # æ½œå˜é‡é…ç½®
  dim: 64                     # æ½œå˜é‡ç»´åº¦
  project_channels: 4         # æŠ•å½±åˆ°ç©ºé—´ç‰¹å¾å›¾çš„é€šé“æ•°

  # KLæ•£åº¦æƒé‡
  beta_max: 0.01              # KLæƒé‡ä¸Šé™
  beta_warmup_steps: 2000     # warmupæ­¥æ•°ï¼ˆå¿«é€Ÿæ”¶æ•›ï¼Œç¼©çŸ­åˆ°2000æ­¥ï¼‰
#  beta_warmup_steps: 3000     # warmupæ­¥æ•°ï¼ˆå¿«é€Ÿæ”¶æ•›ï¼Œç¼©çŸ­åˆ°2000æ­¥ï¼‰
  free_bits: 0.0              # free bitsé˜ˆå€¼

  # ä¸¤é˜¶æ®µè®­ç»ƒ
  prior_freeze_steps: 1000    # priorå†»ç»“æ­¥æ•°ï¼ˆå¿«é€Ÿæ”¶æ•›ï¼Œç¼©çŸ­åˆ°1000æ­¥ï¼‰
#  prior_freeze_steps: 2000    # priorå†»ç»“æ­¥æ•°ï¼ˆå¿«é€Ÿæ”¶æ•›ï¼Œç¼©çŸ­åˆ°1000æ­¥ï¼‰

  # ç¼–ç å™¨é…ç½®
  prior:
    base_channels: 32
    num_layers: 4
    max_channels: 256
  encoder:
    base_channels: 32
    num_layers: 4
    max_channels: 256

# æ•°æ®é›†é…ç½®
dataset:
  image_path: /home/ldingaj/dataset/D1
#  image_path: D:\datasets\radio_images
  label_path:
  size: 512                 # ç›®æ ‡å›¾åƒå°ºå¯¸
  n_classes:
  n_channels: 1             # å•é€šé“ï¼ˆå°„ç”µå›¾åƒï¼‰
  from_uv: False
  real_data: False
  power: 2
  use_zeros: True
  max_samples: None         # é™åˆ¶æ•´ä¸ªæ•°æ®é›†æœ€å¤šä½¿ç”¨5000ä¸ªæ ·æœ¬ï¼ˆNoneè¡¨ç¤ºä½¿ç”¨å…¨éƒ¨ï¼‰

comment: pretrained_ddpm_with_variational_inference
# é…ç½®è¯´æ˜ï¼š
#
# 1. é¢„è®­ç»ƒæ¨¡å‹ä¼˜åŠ¿
#    âœ… æ›´å¿«çš„æ”¶æ•›é€Ÿåº¦ï¼ˆ50-70%è®­ç»ƒæ—¶é—´ï¼‰
#    âœ… æ›´å¥½çš„ç”Ÿæˆè´¨é‡ï¼ˆç‰¹åˆ«æ˜¯çº¹ç†ç»†èŠ‚ï¼‰
#    âœ… æ›´å¼ºçš„æ³›åŒ–èƒ½åŠ›
#    âœ… é™ä½è¿‡æ‹Ÿåˆé£é™©
#
# 2. é€šé“é€‚é…
#    - é¢„è®­ç»ƒæ¨¡å‹: 3é€šé“ (RGB)
#    - æˆ‘ä»¬çš„è¾“å…¥: 2é€šé“ (x_t + dirty) + 4é€šé“ (latent) = 6é€šé“
#    - conv_inå±‚ä¼šè‡ªåŠ¨é€‚é…ï¼Œé‡ç”¨å‰2-3ä¸ªé€šé“çš„æƒé‡
#
# 3. å†»ç»“ç­–ç•¥é€‰æ‹©
#    - "all": é€‚åˆæ•°æ®é‡å¾ˆå°çš„æƒ…å†µï¼ˆ<1000æ ·æœ¬ï¼‰
#    - "partial": æ¨èç­–ç•¥ï¼Œå¹³è¡¡è®­ç»ƒæ•ˆç‡å’Œé€‚åº”æ€§
#    - "none": é€‚åˆæ•°æ®é‡å¤§ä¸”é¢†åŸŸå·®å¼‚å¤§çš„æƒ…å†µï¼ˆ>10000æ ·æœ¬ï¼‰
#
# 4. å­¦ä¹ ç‡è°ƒæ•´
#    - é¢„è®­ç»ƒæ¨¡å‹éœ€è¦æ›´å°çš„å­¦ä¹ ç‡ï¼ˆ5e-5 vs 1e-4ï¼‰
#    - é¿å…ç ´åé¢„è®­ç»ƒæƒé‡
#    - å¦‚æœä½¿ç”¨"none"ç­–ç•¥ï¼Œå¯ä»¥é€‚å½“æé«˜åˆ°8e-5
#
# 5. è®­ç»ƒæ—¶é•¿ï¼ˆå¿«é€Ÿé…ç½®ï¼‰
#    - é¢„è®¡éœ€è¦20-30kæ­¥å³å¯æ”¶æ•›ï¼ˆä½¿ç”¨è½»é‡åŒ–æ¨¡å‹+å®Œå…¨å†»ç»“ç­–ç•¥ï¼‰
#    - éªŒè¯lossé€šå¸¸åœ¨10-15kæ­¥å¼€å§‹æ”¶æ•›
#    - Early stoppingä¼šåœ¨3ä¸ªepochæ— æ”¹å–„åè‡ªåŠ¨åœæ­¢
#    - batch_size=16é€‚åˆclusterç¯å¢ƒï¼Œè®­ç»ƒé€Ÿåº¦æ›´å¿«
#
# 6. å…¼å®¹æ€§
#    - å®Œå…¨å…¼å®¹ç°æœ‰çš„æ•°æ®åŠ è½½pipeline
#    - å®Œå…¨å…¼å®¹ç°æœ‰çš„å˜åˆ†æ¨æ–­æ¨¡å—
#    - æ¨ç†æ¥å£ä¿æŒä¸€è‡´
#
# 7. è½»é‡åŒ–é€‰é¡¹ï¼ˆæ–°å¢ï¼‰
#    - model_sizeé¢„è®¾ï¼šå¿«é€Ÿé€‰æ‹©æ¨¡å‹å¤§å°ï¼ˆsmall/medium/largeï¼‰
#    - æ™ºèƒ½æƒé‡è¿ç§»ï¼šè‡ªåŠ¨è¿ç§»åŒ¹é…çš„é¢„è®­ç»ƒæƒé‡
#    - ç¤ºä¾‹ï¼šè®¾ç½®model_size: "small"å¯å‡å°‘75%å‚æ•°é‡
#    - ä½¿ç”¨æ–¹æ³•ï¼šåœ¨pretrainedéƒ¨åˆ†è®¾ç½® model_size: "small" æˆ– "medium"
#
# å¿«é€Ÿå¼€å§‹ï¼š
# python train_generator.py --config configs/generator_pretrained.yaml --module pretrained
#
# ä½¿ç”¨è½»é‡åŒ–æ¨¡å‹ï¼š
# åœ¨pretrainedéƒ¨åˆ†è®¾ç½® model_size: "small" æˆ– "medium"
# ä¾‹å¦‚ï¼š
#   pretrained:
#     model_id: "google/ddpm-celebahq-256"
#     model_size: "small"  # å‚æ•°é‡å‡å°‘çº¦75%